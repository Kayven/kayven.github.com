<!DOCTYPE html>
<html>
<head>
	
	<title>利用UIWebView实现富文本编辑器 - kayven's library</title>
	
	
	<meta name="author" content="ddrccw" />
	
	<meta name="description" content="how to make a rich text editor in UIWebView" />
	

	
	<meta name="keywords" content="UIWebView rich-text-editor iOS javascript" />	
	

	<meta name="robots" content="noodp, nydir" />
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	
	<link href="/css/blueprint/screen.css" type="text/css" rel="stylesheet" />
	<!--[if lt IE 8]> <link href="/css/blueprint/ie.css" type="text/css" rel="stylesheet" /> <![endif]-->	 
	<link href="/css/railscasts.css" type="text/css" rel="stylesheet" />
	<link href="/css/site.css" type="text/css" rel="stylesheet" />

	<script type="text/javascript" src="/js/writeCapture-1.0.5-nolib-min.js"></script>
		<script type="text/javascript" src="/js/jquery.js"></script>
	<script type="text/javascript" src="/js/site.js"></script>
	<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-34556823-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
	<script src="https://www.google.com/jsapi" type="text/javascript"></script>
  <script language="Javascript" type="text/javascript">
  //<![CDATA[
google.load("search", "1");

function OnLoad() {
	// Create a search control
	var searchControl = new google.search.SearchControl();
	
	// Add in a WebSearch
	var webSearch = new google.search.WebSearch();
	
	// Restrict our search to pages from this site
	webSearch.setSiteRestriction('ddrccw.github.com');
	
	// Add the searcher to the SearchControl
	searchControl.addSearcher(webSearch);
	
	// tell the searcher to draw itself and tell it where to attach
	searchControl.draw(document.getElementById("searchcontrol"));
	// Add the value of "Search..." to the input field and a class of .empty
}

google.setOnLoadCallback(function() {
  $(function() {
	OnLoad()
	$(".gsc-input > input").val("Search... powered by Google").addClass("empty");
	 
	// When you click on #search
	$(".gsc-input > input").focus(function(){
	 
		// If the value is equal to "Search..."
		if($(this).val() == "Search... powered by Google") {
			// remove all the text and the class of .empty
			$(this).val("").removeClass("empty");;
		}
		this.select();
	});
	 
	// When the focus on #search is lost
	$(".gsc-input > input").blur(function(){
	 
		// If the input field is empty
		if($(this).val() == "") {
			// Add the text "Search..." and a class of .empty
			$(this).val("Search... powered by Google").addClass("empty");
		}
	});

	$("#comment_heading").click(function()
	{
		$(this).next("#disqus_thread").slideToggle(500);
		if($(this).text() == "Show Comments") {
			$(this).text("Hide Comments")
		}else{
			$(this).text("Show Comments")
		}
	});
		
  });
});


  //]]>
  </script>

</head>

<body>
	<div class="container">
	<!-- <div class="container showgrid"> -->
		<div id="header" class="span-24">
  <div id="menu" class="span-15 last">
    <ul>
      <li class="first"><a href="/">Home</a></li>
      <li><a href="/about">About</a></li>
      <li><a href="/blog">Blog</a></li>
      <li><a href="/archives">Archives</a></li>
      <li><a href="/projects">Projects</a></li>
      <!--<li class="last"><a id="mail" href="mailto:ddrccw@gmail.com">Contact</a></li>-->
    </ul>
  </div>
</div>

		
		<div id="main" class="span-17">
			<style type="text/css">
h3,h4{ 
	color: #335E8D;
}			
h3,h4 {
	margin-left		: 3px;
	font-variant	: small-caps;
	font-weight		: normal;
	border-bottom : 1px dotted #ccc;	
}
</style>




<div class="post" id="main-content">
	<h1>利用UIWebView实现富文本编辑器</h1>
	<h4 class="large-bottom">
		Posted on March 09, 2013
		 in <a href="/categories/ios-dev">iOS-dev</a> 

		<span class="tag-list">
			
			<a href="/tags/uiwebview">UIWebView</a>
			
			<a href="/tags/rich-text-editor">rich-text-editor</a>
			
			<a href="/tags/ios">iOS</a>
			
			<a href="/tags/javascript">javascript</a>
			
		</span>
	</h4>
	
	<div class="content">
		<h2>正文</h2>

<p>最近的一个ipad项目有需求，需要在iOS客户端上实现一个笔记功能。由于之前的一个版本对于笔记的功能要求不高，我也只是用UITextView实现了简单的录入。但是接下来的一个版本对于笔记的功能则是希望有web端富文本编辑器的所见即所得的效果。</p>

<p>刚开始，我还以为只能通过Core Text实现。如果要考虑基于HTML实现录入内容的跨平台展现，可能还需要做一番HTML到NSAttributeString的对应转换，而且很多东西如复制要自己实现，比较麻烦。</p>

<p>后来，上网查阅了一番，经tx的<a href="http://f2e.us/slides/iOS_Rich_Editor/iOS_Rich_Editor.html#slide1">ayangxu</a>的PPT的提点，发现可以用UIWebView实现富文本编辑，而且现今比较知名的app--evernote，似乎就是利用了该技术。这点在我导出笔记文件enex并用编辑器打开发现webkit相关字眼之后也确实得到了验证。大体了解了相关原理，主要是利用了webkit支持HTML5属性contenteditable（就是前段时间讨论的比较热闹的话题--一行代码可把浏览器成变临时编辑器）。与Core Text相比，优点在于节省了需要自己实现HTML到Core Text的繁琐转换；缺点嘛，就是到时出来的HTML片段可能只有在safari浏览器中才表现正常。</p>

<p>权衡利弊，最终我还是决定用UIWebView来实现富文本编辑。这里先感叹下HTML5的强大。 ^_^</p>

<h3>实现</h3>

<p>参看国外某大大的《<a href="http://ios-blog.co.uk/featured-posts/ios-5-rich-text-editing-series/">iOS 5 Rich Text Editing Series</a>》，确实给了我很大的帮助。
仔细研读了一下其中的代码，我发现实现起来并不是我原本想象中的那么复杂。关键点概述如下：</p>

<ol>
<li><p>富文本片段状态的获取和实现都是基于webkit内建的富文本编辑器。</p>

<p> 编辑器的api可以参考w3c的《<a href="https://dvcs.w3.org/hg/editing/raw-file/tip/editing.html">HTML Editing APIs</a>》。如果觉得那个文档太复杂，也可以参考Firefox的<a href="https://developer.mozilla.org/en-US/docs/Midas">Midas</a>的api，如编辑相关的<a href="https://developer.mozilla.org/en-US/docs/Rich-Text_Editing_in_Mozilla#Executing_Commands">command</a>。还有IE的<a href="http://msdn.microsoft.com/en-us/library/ms533049(v=vs.85).aspx">Command Identifiers</a>。至于webkit本身似乎相关的文档比较少，我没找到。</p></li>
<li><p>iOS端设置一个timer，可及时获取光标所在片段的文本状态。</p></li>
<li>一些交互的操作，比如拖拽图片，光标定位，需要借助javascript，了解selection，range等对象的操作，相关api可以参考《<a href="https://developer.mozilla.org/en-US/docs/Gecko_DOM_Reference">Gecko DOM Reference</a>》</li>
</ol>


<p>注：  iOS端是利用UIWebView的<code>stringByEvaluatingJavaScriptFromString</code>方法与javascript交互。</p>

<p>参看<a href="http://f2e.us/slides/iOS_Rich_Editor/iOS_Rich_Editor.html#slide1">ayangxu</a>的PPT，他用了较多的hack方法，但目前实际实现过程中，我除了在去除键盘上的黑条用了一点取巧的办法，其他基本上使用的都是sdk的api，具体效果也还是可以接受的，不过还有待完善。</p>

<p>具体代码参看可以<a href="https://github.com/ddrccw/CCRichTextEditor">点我</a>。</p>

<h3>遇到的问题</h3>

<p><a href="http://f2e.us/slides/iOS_Rich_Editor/iOS_Rich_Editor.html#slide1">ayangxu</a>的PPT讨论了不少可能出现的问题（虽然我也没都遇到-。-）。我也顺便补充个小问题好了。</p>

<h4>弹出的UIMenuController</h4>

<p>平常使用时，往往可以通过方法</p>

<p><code>- (BOOL)canPerformAction:(SEL)action withSender:(id)sender;</code></p>

<p>返回YES/NO，控制UIMenuController上系统menuItem的出现与否。但是对于UIWebView（iOS>=5），该方法不可行，系统menuItem始终会出现。原因在于决定其响应展示的view是UIWebBrowserView。虽然可以通过category覆盖相应的方法控制，但是该类是私有的，如果app要过审核的话，最好还是不要动它。</p>

<p>另外，UIWebView在ios5上使用时，弹出的UIMenuController的系统menuItem中没有BIU的选项。iOS6中则有，相当于有个二级菜单包含加粗，斜体和下划线。</p>

<h2>引申</h2>

<h3>UIWebView中javascript调试相关</h3>

<p>当要写的javascript代码比较复杂时，尽管可以通过alert的方法调试，但是console的log等方法输出的信息，却是不可见的。还好stackoverflow上有人提供了一个<a href="http://stackoverflow.com/questions/6508313/javascript-console-log-in-an-ios-uiwebview/6508343#6508343">解决方案</a>，使得log的信息可以输出到xcode的debug终端。</p>

<h3>CoreText is better?</h3>

<p>尽管用UIWebView比较容易实现富文本编辑，但实际开发过程中，我觉得对于UIWebView的可控性上感觉还是比较少。DTCoreText的作者就在《<a href="http://www.cocoanetics.com/2011/01/uiwebview-must-die/">UIWebView must die</a>》中列举UIWebView的种种不是。看了<a href="http://www.cocoanetics.com/2013/02/dtrichtexteditor-1-2/">DTRichTextEditor</a>的demo，至少可以确定Core Text是可行的。如果有机会的话，不妨了解一下Core Text的实现。</p>

<p>下面列举一些使用Core Text的富文本展示的项目，希望有所帮助。</p>

<ul>
<li><a href="https://github.com/Cocoanetics/DTCoreText">DTCoreText</a></li>
<li><a href="https://github.com/enormego/EGOTextView">EGOTextView</a></li>
<li><a href="https://github.com/jeremytregunna/JTextView">JTextView</a></li>
<li><a href="https://github.com/FuerteInternational/FTCoreText">FTCoreText</a></li>
<li><a href="https://github.com/honcheng/RTLabel">RTLabel</a></li>
</ul>


	</div>
	
	<div class="next-prev-nav low-top">
		
		-----------------------------------
		<b>本文内容遵从<a title="Content licenced under Creative Commons by-nc-sa 3.0" href="http://creativecommons.org/licenses/by-nc-sa/3.0/deed.zh">CC版权协议</a>转载请注明出自<a href="http://ddrccw.github.com">ddrccw</a></b>
		-----------------------------------
		<hr/>
		
		
		
	
		
		
	
		
			<a href="/2013/01/29/daily-build-and-create-ipa-using-shell-script" rel="previous" title="使用shell脚本build并创建ipa文件">使用shell脚本build并创建ipa文件</a>&nbsp;&raquo;
		
	
		<br />
	</div>

	<hr />
	<!--<div class="sharing">
	
	 
	
	
	
	
	
	
	 
</div>
 -->
	

<script type="text/javascript">
      var disqus_shortname = 'kayven';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://kayven.github.com/2013/03/09/how-to-make-a-rich-text-editor-in-uiwebview';
        var disqus_url = 'http://kayven.github.com/2013/03/09/how-to-make-a-rich-text-editor-in-uiwebview';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>


	<div>
		<h2 id='comment_heading'>Hide Comments</h2>
		<div id="disqus_thread" aria-live="polite"><div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'ddrccw'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
	</div>
</div>

		</div>
		
		
			<div id="sidebar" class="span-6 push-1 last">
	<div class="sidebar-module" id='gsearcher'>
				 
		<div id="searchcontrol">
			
		</div>
		
	</div>

	<div class="sidebar-module">
		<div class="title"><a href='/tags'>Tags</a></div>
		
            <span style="font-size: 75%">
              <a href="/tags/gmt/" title="1 post">GMT</a>
            </span>
          
            <span style="font-size: 75%">
              <a href="/tags/google/" title="1 post">Google</a>
            </span>
          
            <span style="font-size: 75%">
              <a href="/tags/ide/" title="1 post">IDE</a>
            </span>
          
            <span style="font-size: 75%">
              <a href="/tags/ipcu/" title="1 post">IPCU</a>
            </span>
          
            <span style="font-size: 75%">
              <a href="/tags/lion/" title="1 post">Lion</a>
            </span>
          
            <span style="font-size: 75%">
              <a href="/tags/nsdate/" title="1 post">NSDate</a>
            </span>
          
            <span style="font-size: 75%">
              <a href="/tags/nsdateformatter/" title="1 post">NSDateFormatter</a>
            </span>
          
            <span style="font-size: 75%">
              <a href="/tags/objective-c/" title="1 post">Objective-c</a>
            </span>
          
            <span style="font-size: 75%">
              <a href="/tags/settings-bundle/" title="1 post">Settings.bundle</a>
            </span>
          
            <span style="font-size: 75%">
              <a href="/tags/uinavigationbar/" title="1 post">UINavigationBar</a>
            </span>
          
            <span style="font-size: 75%">
              <a href="/tags/uiwebview/" title="1 post">UIWebView</a>
            </span>
          
            <span style="font-size: 75%">
              <a href="/tags/utc/" title="1 post">UTC</a>
            </span>
          
            <span style="font-size: 75%">
              <a href="/tags/vmware/" title="1 post">VMware</a>
            </span>
          
            <span style="font-size: 75%">
              <a href="/tags/xcode/" title="1 post">Xcode</a>
            </span>
          
            <span style="font-size: 75%">
              <a href="/tags/zbar/" title="1 post">ZBar</a>
            </span>
          
            <span style="font-size: 75%">
              <a href="/tags/build-setting/" title="1 post">build setting</a>
            </span>
          
            <span style="font-size: 75%">
              <a href="/tags/c/" title="1 post">c</a>
            </span>
          
            <span style="font-size: 75%">
              <a href="/tags/c++/" title="1 post">c++</a>
            </span>
          
            <span style="font-size: 75%">
              <a href="/tags/code-style/" title="1 post">code-style</a>
            </span>
          
            <span style="font-size: 75%">
              <a href="/tags/codeblock/" title="1 post">codeblock</a>
            </span>
          
            <span style="font-size: 75%">
              <a href="/tags/daily-build/" title="1 post">daily build</a>
            </span>
          
            <span style="font-size: 75%">
              <a href="/tags/debug/" title="1 post">debug</a>
            </span>
          
            <span style="font-size: 75%">
              <a href="/tags/dual-system/" title="1 post">dual-system</a>
            </span>
          
            <span style="font-size: 75%">
              <a href="/tags/fedora/" title="1 post">fedora</a>
            </span>
          
            <span style="font-size: 75%">
              <a href="/tags/gdb/" title="1 post">gdb</a>
            </span>
          
            <span style="font-size: 75%">
              <a href="/tags/github/" title="1 post">github</a>
            </span>
          
            <span style="font-size: 75%">
              <a href="/tags/github-pages/" title="1 post">github-pages</a>
            </span>
          
            <span style="font-size: 280%">
              <a href="/tags/ios/" title="8 posts">iOS</a>
            </span>
          
            <span style="font-size: 75%">
              <a href="/tags/ipad/" title="1 post">iPad</a>
            </span>
          
            <span style="font-size: 75%">
              <a href="/tags/iphone/" title="1 post">iPhone</a>
            </span>
          
            <span style="font-size: 75%">
              <a href="/tags/itouch/" title="1 post">iTouch</a>
            </span>
          
            <span style="font-size: 75%">
              <a href="/tags/ios6/" title="1 post">ios6</a>
            </span>
          
            <span style="font-size: 75%">
              <a href="/tags/ipa/" title="1 post">ipa</a>
            </span>
          
            <span style="font-size: 75%">
              <a href="/tags/javascript/" title="1 post">javascript</a>
            </span>
          
            <span style="font-size: 75%">
              <a href="/tags/jekyll/" title="1 post">jekyll</a>
            </span>
          
            <span style="font-size: 75%">
              <a href="/tags/linux/" title="1 post">linux</a>
            </span>
          
            <span style="font-size: 75%">
              <a href="/tags/lldb/" title="1 post">lldb</a>
            </span>
          
            <span style="font-size: 75%">
              <a href="/tags/rich-text-editor/" title="1 post">rich-text-editor</a>
            </span>
          
            <span style="font-size: 75%">
              <a href="/tags/shell/" title="1 post">shell</a>
            </span>
          
            <span style="font-size: 75%">
              <a href="/tags/upgrade/" title="1 post">upgrade</a>
            </span>
          
            <span style="font-size: 75%">
              <a href="/tags/win7/" title="1 post">win7</a>
            </span>
          
	</div>

	<div class="sidebar-module">
		<div class="title"><a href='/categories'>Categories</a></div>
		<a href="/categories/usage"><strong>Usage</strong></a> (4)<br /><a href="/categories/c,c++"><strong>c,c++</strong></a> (1)<br /><a href="/categories/ios-dev"><strong>iOS-dev</strong></a> (9)<br />
	</div>
	
	<div class="sidebar-module">
		<div class="title"><a href='/archives'>Archives</a></div>
		<a href="/2013/03"><strong>March 2013</strong></a> (1)<br /><a href="/2013/01"><strong>January 2013</strong></a> (1)<br /><a href="/2012/12"><strong>December 2012</strong></a> (2)<br /><a href="/2012/11"><strong>November 2012</strong></a> (1)<br /><a href="/2012/10"><strong>October 2012</strong></a> (1)<br /><a href="/2012/09"><strong>September 2012</strong></a> (1)<br /><a href="/2012/08"><strong>August 2012</strong></a> (1)<br /><a href="/2012/07"><strong>July 2012</strong></a> (1)<br /><a href="/2012/06"><strong>June 2012</strong></a> (1)<br /><a href="/2012/05"><strong>May 2012</strong></a> (1)<br /><a href="/2012/02"><strong>February 2012</strong></a> (3)<br />
	</div>
</div>

		
		
		<div id="footer" class="span-24"> 
<span  title="Content licenced under Creative Commons by-nc-sa 3.0">版权所有<a title="Content licenced under Creative Commons by-nc-sa 3.0" href="http://creativecommons.org/licenses/by-nc-sa/3.0/deed.zh">&copy;</a> 
	2012-2013 ddrccw。
</span> 
&nbsp;&nbsp;&nbsp;&nbsp; <a href="https://github.com/ddrccw">GitHub</a>
&nbsp;&nbsp;&nbsp;&nbsp; <a href="http://weibo.com/u/1706572835">新浪微博</a>
 &nbsp;&nbsp;&nbsp;&nbsp; <a href="http://twitter.com/addfgg">Twitter</a>
&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;
<span>
	主题由<a title="site's theme made by Bilal Hussain" href="http://bilalh.github.com">Bilal Hussain Hussain</a>提供。
</span>
</div>

	</div>
	
</body>
</html>
